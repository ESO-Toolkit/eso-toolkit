name: 'Build and Deploy'
description: 'Build React app and Storybook, then deploy to GitHub Pages'
inputs:
  enable_sourcemaps:
    description: 'Enable source map generation'
    required: false
    default: 'false'
  release_version:
    description: 'Release version to set in environment'
    required: false
    default: ''
outputs:
  deployment-url:
    description: 'URL where the site was deployed'
    value: ${{ steps.deployment.outputs.page_url }}
runs:
  using: 'composite'
  steps:
    - uses: ./.github/actions/setup-node-with-cache

    - name: Set release version
      if: inputs.release_version != ''
      shell: bash
      run: |
        echo "REACT_APP_VERSION=${{ inputs.release_version }}" >> $GITHUB_ENV
        echo "VITE_RELEASE_VERSION=${{ inputs.release_version }}" >> $GITHUB_ENV

    - name: Setup Pages
      uses: actions/configure-pages@v5
      id: setup

    - name: Build project
      shell: bash
      run: |
        export GENERATE_SOURCEMAP=${{ inputs.enable_sourcemaps }}
        export NODE_ENV=production
        npm run build
      env:
        VITE_BASE_URL: '${{steps.setup.outputs.base_url}}'

    - name: Build Storybook
      shell: bash
      run: |
        export DISABLE_ESLINT_PLUGIN=true
        export STORYBOOK_BASE_PATH="${{steps.setup.outputs.base_url}}storybook/"
        npm run build-storybook

    - name: Move Storybook to build directory
      shell: bash
      run: |
        mkdir -p build/storybook
        cp -r storybook-static/* build/storybook/

    - name: Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./build

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
