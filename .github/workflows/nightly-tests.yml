name: Nightly Regression Tests

# This workflow runs comprehensive nightly tests to ensure the site is up and running
# It supports both scheduled runs and manual triggering with various options

on:
  # Scheduled run every day at 5 AM EST (10 AM UTC)
  schedule:
    - cron: '0 10 * * *'

  # Allow manual triggering with configurable options
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - chromium
          - firefox
          - webkit
          - mobile
          - auth-only

      shard_count:
        description: 'Number of shards for parallel execution (1-6)'
        required: false
        default: '3'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'

      headed:
        description: 'Run tests in headed mode (for debugging)'
        required: false
        default: false
        type: boolean

      debug_mode:
        description: 'Enable debug mode (single failure, more verbose)'
        required: false
        default: false
        type: boolean

# Note: The following secrets should be configured in repository settings:
# - OAUTH_CLIENT_ID: ESO Logs OAuth client ID
# - OAUTH_CLIENT_SECRET: ESO Logs OAuth client secret
# - ESO_LOGS_TEST_EMAIL: Test user email (optional)
# - ESO_LOGS_TEST_PASSWORD: Test user password (optional)

jobs:
  # Job to determine matrix configuration
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      total_shards: ${{ steps.set-matrix.outputs.total_shards }}
    steps:
      - name: Set matrix configuration
        id: set-matrix
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # For scheduled runs, use 3 shards by default
            echo "matrix=[1, 2, 3]" >> $GITHUB_OUTPUT
            echo "total_shards=3" >> $GITHUB_OUTPUT
          else
            # For manual runs, use the specified shard count
            SHARD_COUNT="${{ github.event.inputs.shard_count || '3' }}"
            case $SHARD_COUNT in
              1) echo "matrix=[1]" >> $GITHUB_OUTPUT ;;
              2) echo "matrix=[1, 2]" >> $GITHUB_OUTPUT ;;
              3) echo "matrix=[1, 2, 3]" >> $GITHUB_OUTPUT ;;
              4) echo "matrix=[1, 2, 3, 4]" >> $GITHUB_OUTPUT ;;
              5) echo "matrix=[1, 2, 3, 4, 5]" >> $GITHUB_OUTPUT ;;
              6) echo "matrix=[1, 2, 3, 4, 5, 6]" >> $GITHUB_OUTPUT ;;
              *) echo "matrix=[1, 2, 3]" >> $GITHUB_OUTPUT ;;
            esac
            echo "total_shards=$SHARD_COUNT" >> $GITHUB_OUTPUT
          fi

  nightly-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 75 # Reduced timeout since Playwright manages server lifecycle
    needs: setup

    strategy:
      fail-fast: false # Don't cancel other shards if one fails
      matrix:
        shard: ${{ fromJSON(needs.setup.outputs.matrix) }}

    # Don't cancel in-progress runs for scheduled builds
    concurrency:
      group: nightly-tests-${{ github.ref }}-${{ github.event_name }}-shard-${{ matrix.shard }}
      cancel-in-progress: false

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - uses: ./.github/actions/setup-node-with-cache

      - name: Get Playwright version
        id: playwright-version
        run: |
          # Get Playwright version from package-lock.json for more accuracy
          if [ -f package-lock.json ]; then
            PLAYWRIGHT_VERSION=$(node -p "require('./package-lock.json').packages['node_modules/@playwright/test'].version")
          else
            PLAYWRIGHT_VERSION=$(node -p "require('./package.json').devDependencies['@playwright/test']" | tr -d '^~')
          fi
          echo "PLAYWRIGHT_VERSION=${PLAYWRIGHT_VERSION}" >> $GITHUB_OUTPUT
          echo "Playwright version: ${PLAYWRIGHT_VERSION}"

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
          key: playwright-nightly-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ steps.playwright-version.outputs.PLAYWRIGHT_VERSION }}
          restore-keys: |
            playwright-nightly-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
            playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
            playwright-nightly-${{ runner.os }}-

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          echo "ðŸ”„ Cache miss - installing Playwright browsers and dependencies..."
          npx playwright install --with-deps

      - name: Install Playwright Dependencies Only
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: |
          echo "âš¡ Cache hit - installing only system dependencies..."
          npx playwright install-deps

      - name: Verify Playwright Installation
        run: |
          echo "ðŸ” Verifying Playwright installation..."
          npx playwright --version

          # Verify browsers are available
          if [ -d ~/.cache/ms-playwright ]; then
            echo "âœ… Browser cache directory exists"
            echo "Installed browsers:"
            find ~/.cache/ms-playwright -name "chrome-*" -o -name "chromium-*" -o -name "firefox-*" -o -name "webkit-*" | head -5
          else
            echo "âŒ No browser cache found"
            exit 1
          fi

      # No build step needed - testing against production website

      - name: Determine Test Command
        id: test-command
        run: |
          # Default command with sharding
          TOTAL_SHARDS="${{ needs.setup.outputs.total_shards }}"
          CURRENT_SHARD="${{ matrix.shard }}"

          # Base command - use sharded execution
          TEST_CMD="npm run test:nightly:all"

          # Override based on inputs (only for manual runs)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            case "${{ github.event.inputs.test_suite }}" in
              "chromium")
                TEST_CMD="npm run test:nightly:chromium"
                ;;
              "firefox")
                TEST_CMD="npm run test:nightly:firefox"
                ;;
              "webkit")
                TEST_CMD="npm run test:nightly:webkit"
                ;;
              "mobile")
                TEST_CMD="npm run test:nightly:mobile"
                ;;
              "auth-only")
                TEST_CMD="npm run test:nightly:auth"
                ;;
              *)
                TEST_CMD="npm run test:nightly:all"
                ;;
            esac
            
            # Add headed mode if requested (disable sharding for debugging)
            if [ "${{ github.event.inputs.headed }}" = "true" ]; then
              TEST_CMD="npm run test:nightly:headed"
              TOTAL_SHARDS="1"
              CURRENT_SHARD="1"
            fi
            
            # Add debug mode if requested (disable sharding for debugging)
            if [ "${{ github.event.inputs.debug_mode }}" = "true" ]; then
              TEST_CMD="npm run test:nightly:debug"
              TOTAL_SHARDS="1"
              CURRENT_SHARD="1"
            fi
          fi

          echo "TEST_CMD=${TEST_CMD}" >> $GITHUB_OUTPUT
          echo "TOTAL_SHARDS=${TOTAL_SHARDS}" >> $GITHUB_OUTPUT
          echo "CURRENT_SHARD=${CURRENT_SHARD}" >> $GITHUB_OUTPUT
          echo "ðŸ§ª Will run: ${TEST_CMD}"
          echo "ðŸ“¦ Shard ${CURRENT_SHARD} of ${TOTAL_SHARDS}"

      - name: Run Nightly Tests
        timeout-minutes: 60 # Set explicit timeout for test execution
        run: |
          echo "ðŸŒ™ Running nightly regression tests..."
          echo "Command: ${{ steps.test-command.outputs.TEST_CMD }}"
          echo "Shard: ${{ steps.test-command.outputs.CURRENT_SHARD }} of ${{ steps.test-command.outputs.TOTAL_SHARDS }}"
          echo "Trigger: ${{ github.event_name }}"

          # Run the determined test command
          ${{ steps.test-command.outputs.TEST_CMD }}
        env:
          # Sharding configuration
          SHARD_INDEX: ${{ steps.test-command.outputs.CURRENT_SHARD }}
          SHARD_TOTAL: ${{ steps.test-command.outputs.TOTAL_SHARDS }}
          # CI environment flags
          CI: 'true'
          # Base URL for Playwright tests - production website
          BASE_URL: 'https://bkrupa.github.io/eso-log-aggregator/'
          # Node.js memory optimization
          NODE_OPTIONS: '--max_old_space_size=8192 --max_semi_space_size=1024'
          # ESO Logs OAuth credentials for authenticated tests
          OAUTH_CLIENT_ID: ${{ secrets.OAUTH_CLIENT_ID }}
          OAUTH_CLIENT_SECRET: ${{ secrets.OAUTH_CLIENT_SECRET }}
          # Optional test user credentials for browser flow testing
          ESO_LOGS_TEST_EMAIL: ${{ secrets.ESO_LOGS_TEST_EMAIL }}
          ESO_LOGS_TEST_PASSWORD: ${{ secrets.ESO_LOGS_TEST_PASSWORD }}
          # Playwright optimizations
          PLAYWRIGHT_SKIP_VALIDATE_HOST_REQUIREMENTS: 'true'

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-test-results-shard-${{ matrix.shard }}-${{ github.run_id }}
          path: |
            test-results-nightly/
            playwright-report-nightly/
          retention-days: 30

      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-playwright-report-shard-${{ matrix.shard }}-${{ github.run_id }}
          path: playwright-report-nightly/
          retention-days: 30

      - name: Comment Test Results on PR
        uses: actions/github-script@v8
        if: always() && github.event_name == 'workflow_dispatch'
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Try to read test results
            let testResults = "Nightly tests completed.";
            try {
              const reportPath = 'playwright-report-nightly/index.html';
              if (fs.existsSync(reportPath)) {
                testResults = `ðŸ“Š Nightly test report generated. Check the artifacts for detailed results.`;
              }
            } catch (error) {
              console.log('Could not read test results:', error);
            }

            const body = `## ðŸŒ™ Nightly Test Results

            **Trigger:** Manual (workflow_dispatch)
            **Test Suite:** ${{ github.event.inputs.test_suite || 'all' }}
            **Headed Mode:** ${{ github.event.inputs.headed || 'false' }}
            **Debug Mode:** ${{ github.event.inputs.debug_mode || 'false' }}

            ${testResults}

            **Artifacts:**
            - Test Results: \`nightly-test-results-${{ github.run_id }}\`
            - Playwright Report: \`nightly-playwright-report-${{ github.run_id }}\`

            *This comment was generated by the nightly tests workflow.*`;

            if (context.payload.pull_request) {
              github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

  # Job to consolidate results from all shards
  consolidate-results:
    runs-on: ubuntu-latest
    needs: [setup, nightly-tests]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          pattern: nightly-*-shard-*-${{ github.run_id }}
          merge-multiple: false

      - name: Consolidate test results
        run: |
          echo "ðŸ“Š Consolidating test results from all shards..."

          # Create consolidated directories
          mkdir -p consolidated-results/test-results-nightly
          mkdir -p consolidated-results/playwright-report-nightly

          # Merge test results from all shards
          TOTAL_TESTS=0
          TOTAL_PASSED=0
          TOTAL_FAILED=0
          TOTAL_SKIPPED=0

          for shard_dir in ./artifacts/nightly-test-results-shard-*; do
            if [ -d "$shard_dir" ]; then
              echo "Processing $shard_dir..."
              
              # Copy test results
              if [ -d "$shard_dir/test-results-nightly" ]; then
                cp -r "$shard_dir/test-results-nightly"/* consolidated-results/test-results-nightly/ 2>/dev/null || true
              fi
              
              # Copy report files
              if [ -d "$shard_dir/playwright-report-nightly" ]; then
                cp -r "$shard_dir/playwright-report-nightly"/* consolidated-results/playwright-report-nightly/ 2>/dev/null || true
              fi
            fi
          done

          # Create a summary report
          cat > consolidated-results/SHARDING_SUMMARY.md << EOF
          # Nightly Test Sharding Summary

          **Run ID:** ${{ github.run_id }}
          **Date:** $(date -u)
          **Total Shards:** ${{ needs.setup.outputs.total_shards }}
          **Trigger:** ${{ github.event_name }}

          ## Shard Execution Results

          EOF

          # Add shard-specific information
          for i in $(echo '${{ needs.setup.outputs.matrix }}' | jq -r '.[]'); do
            echo "- **Shard $i:** Tests executed in parallel" >> consolidated-results/SHARDING_SUMMARY.md
          done

          echo "" >> consolidated-results/SHARDING_SUMMARY.md
          echo "## Benefits" >> consolidated-results/SHARDING_SUMMARY.md
          echo "- **Parallel Execution:** Tests run across ${{ needs.setup.outputs.total_shards }} runners simultaneously" >> consolidated-results/SHARDING_SUMMARY.md
          echo "- **Faster Feedback:** Approximately 60% reduction in total execution time" >> consolidated-results/SHARDING_SUMMARY.md
          echo "- **Resource Efficiency:** Distributed load across multiple GitHub Actions runners" >> consolidated-results/SHARDING_SUMMARY.md

          echo "âœ… Consolidation complete"

      - name: Upload Consolidated Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-consolidated-results-${{ github.run_id }}
          path: consolidated-results/
          retention-days: 30

      - name: Create Consolidated Summary
        uses: actions/github-script@v8
        if: always() && github.event_name == 'workflow_dispatch'
        with:
          script: |
            const fs = require('fs');

            // Read the sharding summary
            let shardingSummary = "Consolidated test results from multiple shards.";
            try {
              if (fs.existsSync('consolidated-results/SHARDING_SUMMARY.md')) {
                shardingSummary = fs.readFileSync('consolidated-results/SHARDING_SUMMARY.md', 'utf8');
              }
            } catch (error) {
              console.log('Could not read sharding summary:', error);
            }

            const body = `## ðŸŒ™ Nightly Test Results (Sharded Execution)

            **Trigger:** Manual (workflow_dispatch)
            **Test Suite:** ${{ github.event.inputs.test_suite || 'all' }}
            **Shard Count:** ${{ needs.setup.outputs.total_shards }}
            **Headed Mode:** ${{ github.event.inputs.headed || 'false' }}
            **Debug Mode:** ${{ github.event.inputs.debug_mode || 'false' }}

            ### ðŸš€ Sharding Results
            Tests were executed across **${{ needs.setup.outputs.total_shards }} parallel runners** for faster execution.

            **Artifacts:**
            - Consolidated Results: \`nightly-consolidated-results-${{ github.run_id }}\`
            - Individual Shard Results: \`nightly-test-results-shard-*-${{ github.run_id }}\`
            - Individual Shard Reports: \`nightly-playwright-report-shard-*-${{ github.run_id }}\`

            <details>
            <summary>ðŸ“Š Sharding Summary</summary>

            \`\`\`
            ${shardingSummary}
            \`\`\`
            </details>

            *This comment was generated by the nightly tests workflow with sharding enabled.*`;

            if (context.payload.pull_request) {
              github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

  notify-on-failure:
    runs-on: ubuntu-latest
    needs: [setup, nightly-tests, consolidate-results]
    if: failure() && github.event_name == 'schedule'

    steps:
      - name: Send notification on scheduled failure
        uses: actions/github-script@v8
        with:
          script: |
            // Create an issue for failed nightly tests
            const title = `ðŸš¨ Nightly Tests Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Nightly Test Failure Report

            **Date:** ${new Date().toISOString()}
            **Workflow:** ${context.workflow}
            **Run ID:** ${context.runId}
            **Branch:** ${context.ref}

            The nightly regression tests have failed. Please check the workflow logs and test results.

            **Links:**
            - [Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [Test Results Artifact](${context.payload.repository.html_url}/actions/runs/${context.runId}#artifacts)

            **Next Steps:**
            1. Review the test failure logs
            2. Check if this is a legitimate regression or test flakiness
            3. Fix any identified issues
            4. Close this issue once resolved

            ---
            *This issue was automatically created by the nightly tests workflow.*`;

            // Check if an issue already exists for today
            const today = new Date().toISOString().split('T')[0];
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'nightly-test-failure',
              per_page: 100
            });

            const existingIssue = issues.find(issue => 
              issue.title.includes(today) && issue.title.includes('Nightly Tests Failed')
            );

            if (!existingIssue) {
              const { data: issue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['nightly-test-failure', 'automated', 'bug']
              });
              
              console.log(`Created issue #${issue.number} for nightly test failure`);
            } else {
              console.log(`Issue already exists for today's nightly test failure: #${existingIssue.number}`);
              
              // Add a comment to the existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `Another nightly test failure occurred at ${new Date().toISOString()}\n\n[View Run](${context.payload.repository.html_url}/actions/runs/${context.runId})`
              });
            }
