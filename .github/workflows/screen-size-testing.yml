name: Screen Size Testing - Visual Regression

# Comprehensive screen size testing with visual regression validation
# Tests core panels and insights analysis across 22+ viewport configurations
# Supports OAuth authentication and API response caching for reliable testing
# Generates interactive HTML reports with detailed screenshot comparisons

# Permissions needed for external repository deployment
permissions:
  contents: read

on:
  # Manual trigger only - run on demand for screen size validation
  workflow_dispatch:
    inputs:
      device_categories:
        description: 'Device categories to test'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - mobile
          - tablet
          - desktop
          - breakpoints
      update_snapshots:
        description: 'Update visual regression snapshots'
        required: false
        default: false
        type: boolean

jobs:
  screen-size-testing:
    name: Screen Size Tests - Core Panels & Insights Analysis (Fast Mode)
    runs-on: ubuntu-latest
    timeout-minutes: 25  # Reduced timeout with optimizations

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref }}

      - name: Setup Node.js with NPM Cache
        uses: ./.github/actions/setup-node-with-cache
        with:
          node-version: '20'

      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-browsers-v2-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            playwright-browsers-v2-${{ runner.os }}-
            playwright-browsers-${{ runner.os }}-

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps

      - name: Install System Dependencies Only
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps

      - name: Cache ESO Logs API Responses
        uses: actions/cache@v4
        id: api-cache
        with:
          path: cache/eso-logs-api/
          key: eso-logs-api-${{ hashFiles('src/**/*.graphql', 'src/**/*.ts') }}-v1
          restore-keys: |
            eso-logs-api-v1

      - name: Clear ESO Logs API Cache
        run: |
          echo "ðŸ§¹ Clearing ESO Logs API cache for fresh test data..."
          rm -rf cache/eso-logs-api/* || true
          rm -rf tests/cache/*.json || true
          echo "âœ… ESO Logs API cache cleared"

      - name: Cache Build Output
        uses: actions/cache@v4
        id: build-cache
        with:
          path: |
            build/
            node_modules/.vite/
          key: build-${{ runner.os }}-${{ hashFiles('package-lock.json', 'vite.config.mjs', 'src/**/*.ts', 'src/**/*.tsx') }}
          restore-keys: |
            build-${{ runner.os }}-${{ hashFiles('package-lock.json', 'vite.config.mjs') }}

      - name: Build Application
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: |
          echo "ðŸ”¨ Building application (cache miss)..."
          npm run build
          npm run generate-version
        env:
          CI: true
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Use Cached Build
        if: steps.build-cache.outputs.cache-hit == 'true'
        run: |
          echo "âœ… Using cached build artifacts"
          npm run generate-version  # Still update version info

      - name: ESO Logs API Cache Statistics
        run: |
          # Cache statistics (minimal by default, detailed on cache miss)
          if [ -d "cache/eso-logs-api" ]; then
            CACHE_COUNT=$(find cache/eso-logs-api -name "*.json" | wc -l)
            CACHE_SIZE=$(du -sh cache/eso-logs-api | cut -f1)
            CACHE_STATUS="${{ steps.api-cache.outputs.cache-hit == 'true' && 'HIT' || 'MISS' }}"
            
            # Show minimal cache info by default
            echo "ðŸ“Š ESO Logs API Cache: $CACHE_STATUS ($CACHE_COUNT files, $CACHE_SIZE)"
            
            # Show detailed statistics only on cache miss (new environment/cache cleared)
            if [[ "${{ steps.api-cache.outputs.cache-hit }}" != "true" ]]; then
              echo "  ðŸ“ Cache entries: $CACHE_COUNT files"
              echo "  ðŸ“ Cache size: $CACHE_SIZE"
              echo "  ðŸ“„ Recent cache files:"
              find cache/eso-logs-api -name "*.json" -printf "%T@ %p\n" | sort -n | tail -3 | cut -d' ' -f2- | sed 's/^/    /'
            fi
          else
            echo "ðŸ“Š ESO Logs API Cache: EMPTY (will create on first API call)"
          fi

      - name: Start Application Server
        run: |
          npm run preview &
          sleep 10
          # Wait for server to be ready
          npx wait-on http://localhost:3000 --timeout 30000
        env:
          CI: true

      - name: Check for Existing Snapshots
        id: check_snapshots
        run: |
          if [ -d "tests/screen-sizes" ] && find tests/screen-sizes -name "*-snapshots" -type d | grep -q .; then
            echo "snapshots_exist=true" >> $GITHUB_OUTPUT
            echo "Found existing snapshots"
          else
            echo "snapshots_exist=false" >> $GITHUB_OUTPUT
            echo "No snapshots found - will generate baseline snapshots"
          fi

      - name: Verify Screen Size Test Configuration
        run: |
          echo "ðŸ” Verifying screen size test suite configuration..."
          echo "Available test files:"
          ls -la tests/screen-sizes/*.spec.ts
          echo ""
          echo "Available configuration:"
          ls -la playwright.screen-sizes.config.ts
          echo ""
          echo "Worker configuration will limit parallel execution to prevent API rate limiting"

      - name: Run Screen Size Tests - All Devices (Fast Mode)
        if: ${{ github.event.inputs.device_categories == 'all' || github.event.inputs.device_categories == '' }}
        run: |
          if [[ "${{ github.event.inputs.update_snapshots }}" == "true" ]] || [[ "${{ steps.check_snapshots.outputs.snapshots_exist }}" == "false" ]]; then
            echo "Running with --update-snapshots (manual: ${{ github.event.inputs.update_snapshots }}, auto: ${{ steps.check_snapshots.outputs.snapshots_exist == 'false' }})"
            npx playwright test --config=playwright.screen-sizes-fast.config.ts tests/screen-sizes/visual-regression-minimal.spec.ts --update-snapshots
          else
            echo "Running without --update-snapshots (using minimal visual regression tests with 8 key screen sizes)"
            npx playwright test --config=playwright.screen-sizes-fast.config.ts tests/screen-sizes/visual-regression-minimal.spec.ts
          fi
        env:
          CI: true
          BASE_URL: http://localhost:3000
          # ESO Logs OAuth credentials for authenticated tests
          OAUTH_CLIENT_ID: ${{ secrets.OAUTH_CLIENT_ID }}
          OAUTH_CLIENT_SECRET: ${{ secrets.OAUTH_CLIENT_SECRET }}
          ESOLOGS_TOKEN_URL: https://www.esologs.com/oauth/token
          # Conservative parallelization to prevent API rate limiting
          PLAYWRIGHT_WORKERS: 3
          # Enable debugging for worker calculations
          PLAYWRIGHT_DEBUG_WORKERS: true
          # Memory optimization for CI
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Run Screen Size Tests - Mobile Only
        if: ${{ github.event.inputs.device_categories == 'mobile' }}
        run: |
          if [[ "${{ github.event.inputs.update_snapshots }}" == "true" ]] || [[ "${{ steps.check_snapshots.outputs.snapshots_exist }}" == "false" ]]; then
            echo "Running with --update-snapshots"
            npx playwright test --config=playwright.screen-sizes.config.ts --project="Mobile*" --project="Android*" tests/screen-sizes/core-panels.spec.ts tests/screen-sizes/insights-analysis.spec.ts --update-snapshots
          else
            echo "Running without --update-snapshots"
            npx playwright test --config=playwright.screen-sizes.config.ts --project="Mobile*" --project="Android*" tests/screen-sizes/core-panels.spec.ts tests/screen-sizes/insights-analysis.spec.ts
          fi
        env:
          CI: true
          BASE_URL: http://localhost:3000
          # ESO Logs OAuth credentials for authenticated tests
          OAUTH_CLIENT_ID: ${{ secrets.OAUTH_CLIENT_ID }}
          OAUTH_CLIENT_SECRET: ${{ secrets.OAUTH_CLIENT_SECRET }}
          ESOLOGS_TOKEN_URL: https://www.esologs.com/oauth/token

      - name: Run Screen Size Tests - Tablet Only
        if: ${{ github.event.inputs.device_categories == 'tablet' }}
        run: |
          if [[ "${{ github.event.inputs.update_snapshots }}" == "true" ]] || [[ "${{ steps.check_snapshots.outputs.snapshots_exist }}" == "false" ]]; then
            echo "Running with --update-snapshots"
            npx playwright test --config=playwright.screen-sizes.config.ts --project="Tablet*" tests/screen-sizes/core-panels.spec.ts tests/screen-sizes/insights-analysis.spec.ts --update-snapshots
          else
            echo "Running without --update-snapshots"
            npx playwright test --config=playwright.screen-sizes.config.ts --project="Tablet*" tests/screen-sizes/core-panels.spec.ts tests/screen-sizes/insights-analysis.spec.ts
          fi
        env:
          CI: true
          BASE_URL: http://localhost:3000
          # ESO Logs OAuth credentials for authenticated tests
          OAUTH_CLIENT_ID: ${{ secrets.OAUTH_CLIENT_ID }}
          OAUTH_CLIENT_SECRET: ${{ secrets.OAUTH_CLIENT_SECRET }}
          ESOLOGS_TOKEN_URL: https://www.esologs.com/oauth/token

      - name: Run Screen Size Tests - Desktop Only
        if: ${{ github.event.inputs.device_categories == 'desktop' }}
        run: |
          if [[ "${{ github.event.inputs.update_snapshots }}" == "true" ]] || [[ "${{ steps.check_snapshots.outputs.snapshots_exist }}" == "false" ]]; then
            echo "Running with --update-snapshots"
            npx playwright test --config=playwright.screen-sizes.config.ts --project="Desktop*" --project="Ultrawide*" tests/screen-sizes/core-panels.spec.ts tests/screen-sizes/insights-analysis.spec.ts --update-snapshots
          else
            echo "Running without --update-snapshots"
            npx playwright test --config=playwright.screen-sizes.config.ts --project="Desktop*" --project="Ultrawide*" tests/screen-sizes/core-panels.spec.ts tests/screen-sizes/insights-analysis.spec.ts
          fi
        env:
          CI: true
          BASE_URL: http://localhost:3000
          # ESO Logs OAuth credentials for authenticated tests
          OAUTH_CLIENT_ID: ${{ secrets.OAUTH_CLIENT_ID }}
          OAUTH_CLIENT_SECRET: ${{ secrets.OAUTH_CLIENT_SECRET }}
          ESOLOGS_TOKEN_URL: https://www.esologs.com/oauth/token

      - name: Run Screen Size Tests - Breakpoints Only
        if: ${{ github.event.inputs.device_categories == 'breakpoints' }}
        run: |
          if [[ "${{ github.event.inputs.update_snapshots }}" == "true" ]] || [[ "${{ steps.check_snapshots.outputs.snapshots_exist }}" == "false" ]]; then
            echo "Running with --update-snapshots"
            npx playwright test --config=playwright.screen-sizes.config.ts --project="*Breakpoint*" tests/screen-sizes/core-panels.spec.ts tests/screen-sizes/insights-analysis.spec.ts --update-snapshots
          else
            echo "Running without --update-snapshots"
            npx playwright test --config=playwright.screen-sizes.config.ts --project="*Breakpoint*" tests/screen-sizes/core-panels.spec.ts tests/screen-sizes/insights-analysis.spec.ts
          fi
        env:
          CI: true
          BASE_URL: http://localhost:3000
          # ESO Logs OAuth credentials for authenticated tests
          OAUTH_CLIENT_ID: ${{ secrets.OAUTH_CLIENT_ID }}
          OAUTH_CLIENT_SECRET: ${{ secrets.OAUTH_CLIENT_SECRET }}
          ESOLOGS_TOKEN_URL: https://www.esologs.com/oauth/token

      - name: Prepare Report for Upload
        if: always()
        run: |
          # Create reports directory with metadata
          mkdir -p screen-size-reports
          
          # Debug: List all files and directories to understand what was created
          echo "=== Debug: Listing all directories and files ==="
          ls -la
          echo ""
          echo "=== Checking for report directories ==="
          
          if [ -d "screen-size-report" ]; then
            echo "âœ“ Found configured screen-size-report directory"
            ls -la screen-size-report/
            cp -r screen-size-report/* screen-size-reports/
            
            # Count screenshots
            SCREENSHOT_COUNT=$(find screen-size-reports/data -name "*.png" 2>/dev/null | wc -l)
            echo "Generated $SCREENSHOT_COUNT screenshots"
            
            # Add test run metadata
            cat > screen-size-reports/test-metadata.json << EOF
          {
            "testRun": {
              "timestamp": "$(date -Iseconds)",
              "branch": "${{ github.ref_name }}",
              "commit": "${{ github.sha }}",
              "workflow": "Screen Size Testing - Core Panels & Insights Analysis",
              "runId": "${{ github.run_id }}",
              "runNumber": "${{ github.run_number }}",
              "deviceCategories": "${{ github.event.inputs.device_categories || 'all' }}",
              "updateSnapshots": "${{ github.event.inputs.update_snapshots }}",
              "screenshotCount": $SCREENSHOT_COUNT
            },
            "reportUrl": "https://bkrupa.github.io/eso-log-aggregator-reports/screen-size-tests/${{ github.ref_name }}/${{ github.run_number }}/index.html"
          }
          EOF
          elif [ -d "playwright-report" ]; then
            echo "âš ï¸  Found default playwright-report directory (fallback mode)"
            ls -la playwright-report/
            cp -r playwright-report/* screen-size-reports/
            
            # Count screenshots in the fallback directory structure
            SCREENSHOT_COUNT=$(find screen-size-reports -name "*.png" 2>/dev/null | wc -l)
            echo "Generated $SCREENSHOT_COUNT screenshots (fallback mode)"
            
            # Add metadata with fallback note
            cat > screen-size-reports/test-metadata.json << EOF
          {
            "testRun": {
              "timestamp": "$(date -Iseconds)",
              "branch": "${{ github.ref_name }}",
              "commit": "${{ github.sha }}",
              "workflow": "Screen Size Testing - Core Panels & Insights Analysis (Fallback Mode)",
              "runId": "${{ github.run_id }}",
              "runNumber": "${{ github.run_number }}",
              "deviceCategories": "${{ github.event.inputs.device_categories || 'all' }}",
              "updateSnapshots": "${{ github.event.inputs.update_snapshots }}",
              "screenshotCount": $SCREENSHOT_COUNT,
              "note": "Report generated from fallback playwright-report directory"
            },
            "reportUrl": "https://bkrupa.github.io/eso-log-aggregator-reports/screen-size-tests/${{ github.ref_name }}/${{ github.run_number }}/index.html"
          }
          EOF
          else
            echo "âŒ No screen size report found - creating error page"
            echo "Available directories:"
            ls -la | grep "^d"
            
            cat > screen-size-reports/index.html << EOF
          <!DOCTYPE html>
          <html><head><title>Screen Size Test Failed</title></head>
          <body>
            <h1>Screen Size Test Failed</h1>
            <p>No test results were generated. The test run may have failed.</p>
            <p>Check the <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">workflow logs</a> for details.</p>
            <h2>Debugging Information</h2>
            <p>Expected report directory: <code>screen-size-report</code></p>
            <p>Fallback directory: <code>playwright-report</code></p>
            <p>Timestamp: $(date -Iseconds)</p>
          </body></html>
          EOF
          fi

      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screen-size-test-report-complete
          path: screen-size-reports/
          retention-days: 90

      - name: Deploy Reports to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.GIST_TOKEN }}
          external_repository: bkrupa/eso-log-aggregator-reports
          publish_dir: screen-size-reports
          destination_dir: screen-size-tests/${{ github.ref_name }}/${{ github.run_number }}
          keep_files: true

      - name: Create Job Summary
        if: always()
        run: |
          echo "# ðŸ“± Screen Size Testing Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "screen-size-reports/test-metadata.json" ]; then
            SCREENSHOT_COUNT=$(cat screen-size-reports/test-metadata.json | grep -o '"screenshotCount": [0-9]*' | grep -o '[0-9]*')
            echo "**Screenshots Generated:** $SCREENSHOT_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ”— View Results" >> $GITHUB_STEP_SUMMARY
          
          BRANCH_NAME="${{ github.ref_name }}"
          REPORT_URL="https://bkrupa.github.io/eso-log-aggregator-reports/screen-size-tests/${BRANCH_NAME}/${{ github.run_number }}/"
          ARTIFACTS_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          echo "ðŸ“Š **[Interactive Report: ${REPORT_URL}](${REPORT_URL})**" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **[Download Artifacts: ${ARTIFACTS_URL}](${ARTIFACTS_URL})**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Features Tested" >> $GITHUB_STEP_SUMMARY
          echo "- **Core Panels** - Players panel with character cards and participant information" >> $GITHUB_STEP_SUMMARY
          echo "- **Insights Analysis** - Damage/healing statistics and fight insights responsive layout" >> $GITHUB_STEP_SUMMARY
          echo "- **22+ Viewport Sizes** - From iPhone SE (375px) to 4K Desktop (3840px) and beyond" >> $GITHUB_STEP_SUMMARY
          echo "- **Real Data** - Authentic ESO combat log data with API caching for reduced server load" >> $GITHUB_STEP_SUMMARY
          echo "- **66 Total Tests** - Comprehensive responsive layout validation across all screen sizes" >> $GITHUB_STEP_SUMMARY

