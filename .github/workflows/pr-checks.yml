name: PR Checks

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - synchronize
      - reopened
      - labeled
      - unlabeled

jobs:
  check-do-not-merge-label:
    runs-on: ubuntu-latest
    steps:
      - name: Check for Do Not Merge or Waiting on Parent labels
        uses: actions/github-script@v8
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(label => label.name.toLowerCase());
            const doNotMergeLabels = ['do not merge', 'do-not-merge', 'wip', 'work in progress', 'waiting on parent', 'waiting-on-parent'];

            const hasDoNotMergeLabel = doNotMergeLabels.some(label => 
              labels.some(prLabel => prLabel.includes(label.toLowerCase()))
            );

            if (hasDoNotMergeLabel) {
              const matchedLabels = labels.filter(prLabel => 
                doNotMergeLabels.some(blockLabel => prLabel.includes(blockLabel.toLowerCase()))
              );
              core.setFailed(`‚ùå This PR has blocking label(s): ${matchedLabels.join(', ')}. The PR cannot be merged until these labels are removed.`);
            } else {
              console.log('‚úÖ No blocking labels found. PR can proceed.');
            }

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/setup-node-with-cache
      - name: Build
        run: npm run build

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/setup-node-with-cache
      - name: Lint
        run: npm run lint

  format:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/setup-node-with-cache
      - name: Check formatting
        run: npm run format:check

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/setup-node-with-cache
      - name: Block external network access
        run: |
          # Block access to known external services during testing
          echo "127.0.0.1 esologs.com" | sudo tee -a /etc/hosts
          echo "127.0.0.1 www.esologs.com" | sudo tee -a /etc/hosts
          echo "127.0.0.1 rpglogs.com" | sudo tee -a /etc/hosts
          echo "127.0.0.1 assets.rpglogs.com" | sudo tee -a /etc/hosts
          echo "127.0.0.1 sentry.io" | sudo tee -a /etc/hosts
          echo "127.0.0.1 fonts.googleapis.com" | sudo tee -a /etc/hosts
          echo "127.0.0.1 fonts.gstatic.com" | sudo tee -a /etc/hosts
          echo "Blocked external services in /etc/hosts:"
          cat /etc/hosts | grep "127.0.0.1"
      - name: Test
        run: npm run test:coverage:ci
        env:
          # Increase Node.js memory limit to prevent OOM errors
          NODE_OPTIONS: '--max-old-space-size=8192'
          # Prevent external network requests during testing
          NO_PROXY: '*'
          HTTP_PROXY: 'http://127.0.0.1:9999'
          HTTPS_PROXY: 'http://127.0.0.1:9999'
          # Block known external services
          BLOCK_EXTERNAL_REQUESTS: 'true'
          # Override external service URLs to localhost (will fail if not mocked)
          ESOLOGS_API_URL: 'http://localhost:3000/mock-api'
          SENTRY_DSN: ''

      - name: Scribing E2E Tests
        run: npm run test:scribing
        env:
          NODE_OPTIONS: '--max-old-space-size=6144'
          NO_PROXY: '*'
          HTTP_PROXY: 'http://127.0.0.1:9999'
          HTTPS_PROXY: 'http://127.0.0.1:9999'
          BLOCK_EXTERNAL_REQUESTS: 'true'
          ESOLOGS_API_URL: 'http://localhost:3000/mock-api'
          SENTRY_DSN: ''

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/setup-node-with-cache
      - name: Typecheck
        run: npm run typecheck

  build-storybook:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/setup-node-with-cache
      - name: Build Storybook
        run: npm run build-storybook
        env:
          DISABLE_ESLINT_PLUGIN: true

  playwright-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: ./.github/actions/setup-node-with-cache

      - name: Get Playwright version
        id: playwright-version
        run: |
          # Get Playwright version from package-lock.json for more accuracy
          if [ -f package-lock.json ]; then
            PLAYWRIGHT_VERSION=$(node -p "require('./package-lock.json').packages['node_modules/@playwright/test'].version")
          else
            PLAYWRIGHT_VERSION=$(node -p "require('./package.json').devDependencies['@playwright/test']" | tr -d '^~')
          fi
          echo "PLAYWRIGHT_VERSION=${PLAYWRIGHT_VERSION}" >> $GITHUB_OUTPUT
          echo "Playwright version: ${PLAYWRIGHT_VERSION}"

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ steps.playwright-version.outputs.PLAYWRIGHT_VERSION }}
          restore-keys: |
            playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
            playwright-${{ runner.os }}-

      - name: Cache status and verification
        run: |
          echo "Cache hit: ${{ steps.playwright-cache.outputs.cache-hit }}"
          echo "Cache key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ steps.playwright-version.outputs.PLAYWRIGHT_VERSION }}"

          # Check if cache directory exists and show contents
          if [ -d ~/.cache/ms-playwright ]; then
            echo "‚úÖ Playwright cache directory exists"
            echo "Cache contents:"
            find ~/.cache/ms-playwright -maxdepth 2 -type d 2>/dev/null || echo "No browser directories found"
          else
            echo "‚ùå Playwright cache directory does not exist"
          fi

      - name: Install Playwright Browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          echo "üîÑ Cache miss - installing Playwright browsers and dependencies..."
          npx playwright install --with-deps

      - name: Install Playwright Dependencies Only
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: |
          echo "‚ö° Cache hit - installing only system dependencies..."
          npx playwright install-deps

      - name: Verify Playwright Installation
        run: |
          echo "üîç Verifying Playwright installation..."
          npx playwright --version

          # Verify browsers are available
          if [ -d ~/.cache/ms-playwright ]; then
            echo "‚úÖ Browser cache directory exists"
            echo "Installed browsers:"
            find ~/.cache/ms-playwright -name "chrome-*" -o -name "chromium-*" -o -name "firefox-*" -o -name "webkit-*" | head -5
          else
            echo "‚ùå No browser cache found"
            exit 1
          fi
      - name: Block external network access
        run: |
          # Block access to known external services during testing
          echo "127.0.0.1 esologs.com" | sudo tee -a /etc/hosts
          echo "127.0.0.1 www.esologs.com" | sudo tee -a /etc/hosts
          echo "127.0.0.1 rpglogs.com" | sudo tee -a /etc/hosts
          echo "127.0.0.1 assets.rpglogs.com" | sudo tee -a /etc/hosts
          echo "127.0.0.1 sentry.io" | sudo tee -a /etc/hosts
          echo "127.0.0.1 fonts.googleapis.com" | sudo tee -a /etc/hosts
          echo "127.0.0.1 fonts.gstatic.com" | sudo tee -a /etc/hosts
          echo "Blocked external services in /etc/hosts:"
          cat /etc/hosts | grep "127.0.0.1"
      - name: Generate version files for cache busting
        run: |
          echo "Generating version files for e2e tests..."
          node scripts/generate-version.cjs
          node scripts/update-manifest.cjs
      - name: Run Playwright smoke tests
        run: |
          echo "Running Playwright smoke tests..."
          echo "Node memory: $NODE_OPTIONS"
          echo "Playwright config: Smoke test mode with single worker"

          # System info for debugging
          echo "System information:"
          echo "CPU cores: $(nproc)"
          echo "Memory: $(free -h | head -2)"
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"

          # Pre-warm the dependency cache
          echo "Pre-warming dependency cache..."
          npm run build --silent || echo "Build failed, continuing with tests..."

          # Optional health check (can be enabled if needed)
          # echo "Running health check..."
          # timeout 60 npm run health-check || echo "Health check failed or timed out, continuing..."

          # Run the smoke tests
          npm run test:smoke:e2e
        env:
          # Node.js memory optimization - increased for stability
          NODE_OPTIONS: '--max_old_space_size=8192 --max_semi_space_size=1024'
          # CI environment flags
          CI: 'true'
          PLAYWRIGHT_SKIP_VALIDATE_HOST_REQUIREMENTS: 'true'
          # Prevent external network requests during testing
          NO_PROXY: '*'
          HTTP_PROXY: 'http://127.0.0.1:9999'
          HTTPS_PROXY: 'http://127.0.0.1:9999'
          # Block known external services
          BLOCK_EXTERNAL_REQUESTS: 'true'
          # Override external service URLs to localhost (will fail if not mocked)
          ESOLOGS_API_URL: 'http://localhost:3000/mock-api'
          SENTRY_DSN: ''
          # Playwright memory optimization
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1'
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: playwright-smoke-report
          path: playwright-report/
          retention-days: 30
