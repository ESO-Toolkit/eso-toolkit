name: Upload Sourcemaps to Rollbar

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  upload-sourcemaps:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: ./.github/actions/setup-node-with-cache

      - name: Set release version
        id: version
        run: |
          RELEASE_VERSION="${GITHUB_SHA:0:8}"
          echo "RELEASE_VERSION=${RELEASE_VERSION}" >> $GITHUB_ENV
          echo "release=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
          echo "Release version: ${RELEASE_VERSION}"

      - name: Build project with sourcemaps
        run: |
          export REACT_APP_VERSION="${{ env.RELEASE_VERSION }}"
          export GENERATE_SOURCEMAP=true

          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            REPO_NAME=$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f2)
            VITE_BASE_URL="/$REPO_NAME/" npm run build
          else
            npm run build
          fi
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          NODE_ENV: production

      - name: Upload sourcemaps to Rollbar
        run: |
          DEPLOYMENT_URL="https://esotk.com"
          UPLOAD_COUNT=0
          FAIL_COUNT=0

          echo "Searching for sourcemap files in ./build/assets/ ..."
          if [ ! -d "./build/assets" ]; then
            echo "❌ Error: build/assets directory not found"
            exit 1
          fi

          while IFS= read -r -d '' mapfile; do
            # Derive the URL of the corresponding minified JS/CSS file
            filename=$(basename "${mapfile}" .map)
            minified_url="${DEPLOYMENT_URL}/assets/${filename}"

            echo "Uploading: ${mapfile} → ${minified_url}"

            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              https://api.rollbar.com/api/1/sourcemap \
              -F "access_token=${{ secrets.ROLLBAR_SERVER_TOKEN }}" \
              -F "version=${{ env.RELEASE_VERSION }}" \
              -F "minified_url=${minified_url}" \
              -F "source_map=@${mapfile}")

            if [ "${HTTP_STATUS}" = "200" ]; then
              UPLOAD_COUNT=$((UPLOAD_COUNT + 1))
              echo "  ✅ Uploaded (HTTP ${HTTP_STATUS})"
            else
              FAIL_COUNT=$((FAIL_COUNT + 1))
              echo "  ❌ Failed (HTTP ${HTTP_STATUS})"
            fi
          done < <(find ./build/assets -name "*.map" -type f -print0)

          echo ""
          echo "Upload complete: ${UPLOAD_COUNT} succeeded, ${FAIL_COUNT} failed"

          if [ "${FAIL_COUNT}" -gt 0 ]; then
            echo "⚠️ Some sourcemaps failed to upload. Check ROLLBAR_SERVER_TOKEN secret."
            exit 1
          fi

          if [ "${UPLOAD_COUNT}" -eq 0 ]; then
            echo "❌ No sourcemaps found to upload"
            exit 1
          fi

      - name: Notify success
        run: |
          echo "✅ Sourcemaps successfully uploaded to Rollbar"
          echo "Release: ${{ env.RELEASE_VERSION }}"
          echo "Environment: production"
        if: success()

      - name: Handle upload failure
        run: |
          echo "❌ Failed to upload sourcemaps to Rollbar"
          echo "Check that ROLLBAR_SERVER_TOKEN is set in repository secrets"
          echo "Use the 'post_server_item' token from your Rollbar project settings"
          exit 1
        if: failure()

