name: Deploy Storybook

on:
  push:
    branches:
      - main
  # Allow manual triggering
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy-storybook:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: ./.github/actions/setup-node-with-cache

      - name: Build Storybook
        run: npm run build-storybook
        env:
          NODE_OPTIONS: '--max-old-space-size=8192'
          CI: true

      - name: Generate Deploy Token
        id: generate-deploy-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.DEPLOY_APP_ID }}
          private-key: ${{ secrets.DEPLOY_APP_PRIVATE_KEY }}
          owner: ESO-Toolkit
          repositories: eso-log-aggregator-reports

      - name: Deploy Storybook to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          # Use personal_token (not github_token) when pushing to an external repository.
          # Despite the name, personal_token accepts any token with sufficient permissions,
          # including tokens generated by a GitHub App. github_token is reserved for the
          # built-in GITHUB_TOKEN, which cannot push to external repositories.
          personal_token: ${{ steps.generate-deploy-token.outputs.token }}
          external_repository: ESO-Toolkit/eso-log-aggregator-reports
          publish_dir: storybook-static
          destination_dir: storybook
          keep_files: true
