<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ESO/WoW Text Preview Tool</title>
    <link rel="stylesheet" href="text-editor.css?v=dev" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400..900&family=Open+Sans:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Optional Pickr theme CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css"
    />
  </head>
  <body>
    <div class="eso-tool">
      <h3>ESO Text Preview Tool</h3>
      <div class="eso-toolbar" role="toolbar" aria-label="Text formatting toolbar">
        <div class="undo-redo-group">
          <button id="undo-btn" onclick="esoTool.undo()" disabled aria-label="Undo last change">
            Undo
          </button>
          <button id="redo-btn" onclick="esoTool.redo()" disabled aria-label="Redo last change">
            Redo
          </button>
        </div>
        <div class="toolbar-divider" aria-hidden="true"></div>
        <button onclick="esoTool.clearFormatting()" aria-label="Clear all formatting from text">
          Clear All Formatting
        </button>
        <button
          onclick="esoTool.removeFormatFromSelection()"
          aria-label="Remove formatting from selection"
        >
          Remove Format
        </button>
        <div class="toolbar-spacer" aria-hidden="true"></div>
        <span class="toolbar-label">Quick Colors:</span>
        <div class="preset-colors" role="group" aria-label="Quick color choices">
          <button
            type="button"
            class="preset-color"
            style="background: #ffff00"
            onclick="esoTool.applyQuickColor('FFFF00')"
            aria-label="Apply yellow color"
          ></button>
          <button
            type="button"
            class="preset-color"
            style="background: #00ff00"
            onclick="esoTool.applyQuickColor('00FF00')"
            aria-label="Apply green color"
          ></button>
          <button
            type="button"
            class="preset-color"
            style="background: #ff0000"
            onclick="esoTool.applyQuickColor('FF0000')"
            aria-label="Apply red color"
          ></button>
          <button
            type="button"
            class="preset-color"
            style="background: #0080ff"
            onclick="esoTool.applyQuickColor('0080FF')"
            aria-label="Apply blue color"
          ></button>
          <button
            type="button"
            class="preset-color"
            style="background: #ff8000"
            onclick="esoTool.applyQuickColor('FF8000')"
            aria-label="Apply orange color"
          ></button>
          <button
            type="button"
            class="preset-color"
            style="background: #ff00ff"
            onclick="esoTool.applyQuickColor('FF00FF')"
            aria-label="Apply magenta color"
          ></button>
        </div>
        <div class="color-picker-wrapper">
          <div class="native-color-group">
            <button
              id="eso-native-emoji-btn"
              type="button"
              class="native-emoji-btn"
              aria-label="Choose custom color"
              onclick="esoTool.openColorPickerUniversal(event)"
            >
              ðŸŽ¨
            </button>
            <span id="eso-pickr-anchor" class="pickr-anchor" aria-hidden="true"></span>
          </div>
        </div>
      </div>
      <textarea
        id="eso-input"
        class="eso-input"
        placeholder="Type your text here or paste ESO/WoW formatted text. Select text and use the buttons above to format."
      ></textarea>
      <div class="status-bar" role="status" aria-live="polite">
        <div class="char-counter">
          <span style="color: #ccc; font-size: 12px">Characters: </span>
          <span id="char-count" style="color: #e2b84d; font-weight: 600">0</span>
        </div>
        <button
          class="copy-button"
          onclick="esoTool.copyToClipboard()"
          title="Copy formatted text to clipboard"
        >
          ðŸ“‹ Copy Text
        </button>
        <span id="sr-status" class="visually-hidden" aria-live="polite"></span>
      </div>
      <div id="eso-preview" class="eso-preview"></div>
    </div>
    <!-- Pickr JS (optional). Your script falls back if this fails to load. -->
    <script>
      window.pickrLoaded = false;
      window.pickrLoadFailed = false;
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"
      onload="window.pickrLoaded=true;"
      onerror="window.pickrLoadFailed=true;"
    ></script>
    <script src="text-editor.js"></script>
    <script>
      // Theme synchronization script
      function syncThemeWithParent() {
        try {
          // Check if we're in an iframe and parent has theme info
          if (window.parent && window.parent !== window) {
            const parentTheme = window.parent.document.documentElement.getAttribute('data-theme');
            if (parentTheme) {
              document.documentElement.setAttribute('data-theme', parentTheme);
            }
          }
        } catch (e) {
          // Cross-origin restrictions, use default theme
          console.log('Could not sync with parent theme, using default');
        }
      }

      // Listen for theme changes from parent
      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'theme-change') {
          const tokens = event.data.tokens;
          if (tokens) {
            Object.entries(tokens).forEach(([key, value]) => {
              document.documentElement.style.setProperty(`--${key}`, value);
            });
            document.body.style.backgroundColor = tokens.bg;
            document.body.style.color = tokens.text;
          }
        }
      });

      // Initialize theme sync
      syncThemeWithParent();

      // Initialize only after DOM is fully ready to ensure toolbar elements exist
      document.addEventListener('DOMContentLoaded', () => {
        if (window.esoTool && typeof esoTool.init === 'function') esoTool.init();
      });
    </script>
    <!-- Lightweight auto-reload on file change (works with Python http.server) -->
    <script>
      (function () {
        const filesToWatch = ['text-editor.html', 'text-editor.css', 'text-editor.js'];
        const lastSeen = new Map();

        async function headOnce(path) {
          // Use HEAD to avoid downloading the whole file; fall back to GET if needed
          try {
            const res = await fetch(path + '?_ts=' + Date.now(), {
              method: 'HEAD',
              cache: 'no-store',
            });
            // Prefer ETag, then Last-Modified; otherwise synthesize a key
            return (
              res.headers.get('etag') ||
              res.headers.get('last-modified') ||
              // Fallback: content length if provided
              res.headers.get('content-length') ||
              Math.random().toString(36)
            );
          } catch (e) {
            // If HEAD fails (some servers), try GET but avoid caching
            try {
              const res = await fetch(path + '?_ts=' + Date.now(), { cache: 'no-store' });
              return (
                res.headers.get('etag') ||
                res.headers.get('last-modified') ||
                res.headers.get('content-length') ||
                Math.random().toString(36)
              );
            } catch (e2) {
              return null;
            }
          }
        }

        let ticking = false;
        async function checkChanges() {
          if (ticking) return; // prevent overlap
          ticking = true;
          try {
            for (const f of filesToWatch) {
              const sig = await headOnce(f);
              if (!sig) continue;
              if (!lastSeen.has(f)) {
                lastSeen.set(f, sig);
              } else if (lastSeen.get(f) !== sig) {
                // Detected change; reload the page
                location.reload();
                return;
              }
            }
          } finally {
            ticking = false;
          }
        }

        // Poll periodically and also when tab becomes visible again
        const interval = setInterval(checkChanges, 1000);
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            checkChanges();
          }
        });

        // Kick off initial snapshot
        checkChanges();

        // Expose a hook for debugging (optional)
        window.__autoReload = { stop: () => clearInterval(interval), check: checkChanges };
      })();
    </script>
  </body>
</html>
